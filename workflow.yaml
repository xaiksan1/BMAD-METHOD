# ‚ö°üåå BMAD v2.0 - TIME COMPRESSION WORKFLOW üåå‚ö°
# "Si ya deux portes, je cr√©e une 3e porte" - Ichigo

workflow_name: bmad-time-compression-experiment
workflow_description: |
  BMAD Party enhanced with time manipulation capabilities.
  Exploits AI time vs human time asymmetry for exponential output generation.
  1 minute human = 1 year AI result = 175,200x compression ratio.

workflow_version: 2.0.0

metadata:
  author: Ichigo (World Lab Outpost)
  created_date: 2025-11-13
  tags:
    - bmad-party
    - time-manipulation
    - multi-llm
    - recursive
    - pattern-discovery
    - exponential-learning
  time_compression_ratio: 175200  # 1 min human = ~2 years AI output
  estimated_human_time: "5 minutes"
  estimated_ai_time: "10 years equivalent"
  value_potential: "billions"

# ====================================================================
# GLOBAL PARAMETERS
# ====================================================================
parameters:
  # Timeouts
  timeout: 0  # No global timeout (let tasks run)
  
  # Retry configuration
  max_retries: 3
  backoff_strategy: exponential
  
  # BMAD Party configuration
  party_mode: true
  llm_participants:
    - claude-3-opus
    - gpt-4-turbo
    - gemini-1.5-pro
  
  # Time manipulation
  time_manipulation_enabled: true
  compression_target_ratio: 100000  # Aim for 100,000x compression
  
  # Auto-classification
  auto_classify: true
  notion_database_id: "{{ env.NOTION_WORLD_LAB_DB }}"
  
  # Custom parameters
  repository_path: "{{ env.PWD }}"
  output_directory: ".bmad/experiments/{{ workflow.run_id }}"
  save_conversation_history: true
  generate_patterns: true
  create_agents_from_patterns: true

# ====================================================================
# WORKFLOW ENTRY POINT
# ====================================================================
start_task: initialize_experiment

# ====================================================================
# TASK DEFINITIONS
# ====================================================================
tasks:
  # --------------------------------------------------------------------
  # PHASE 1: INITIALIZATION
  # --------------------------------------------------------------------
  - id: initialize_experiment
    name: Initialize BMAD Time Compression Experiment
    description: |
      Set up experiment environment, create tracking structures,
      and prepare for time-compressed multi-LLM conversation.
    action: file_operation
    inputs:
      operation: create_directory
      path: "{{ parameters.output_directory }}"
      metadata:
        experiment_type: time_compression
        start_time: "{{ timestamp }}"
        compression_target: "{{ parameters.compression_target_ratio }}"
    timeout: 30
    on_success:
      action: log
      params:
        message: "Experiment {{ workflow.run_id }} initialized. Target: {{ parameters.compression_target_ratio }}x compression"
        level: info
    on_failure:
      action: abort
      params:
        message: "Failed to initialize experiment environment"
    next_task: detect_repository_context

  # --------------------------------------------------------------------
  - id: detect_repository_context
    name: Detect Repository Context
    description: |
      Analyze current repository to understand what we're working with.
      Determines optimal workflow path and initial conversation seed.
    action: code_analysis
    inputs:
      path: "{{ parameters.repository_path }}"
      analyze:
        - file_structure
        - tech_stack
        - readme_content
        - package_manifests
        - git_history
      depth: shallow
    timeout: 60
    retry_policy:
      max_retries: 2
      backoff_strategy: linear
      retry_on:
        - timeout
        - file_system_error
    outputs:
      context:
        type: object
        properties:
          project_type: string
          tech_stack: array
          complexity_score: number
          improvement_potential: array
    input_mapping:
      repository: "$.parameters.repository_path"
    on_success:
      action: save_state
      params:
        key: repository_context
        value: "{{ outputs.context }}"
    next_task:
      default: prepare_bmad_party
      conditions:
        - condition: "outputs.context.complexity_score > 8"
          task_id: request_human_guidance
        - condition: "outputs.context.improvement_potential.length === 0"
          task_id: generate_improvement_ideas

  # --------------------------------------------------------------------
  - id: request_human_guidance
    name: Request Human Guidance (High Complexity)
    description: |
      Repository is highly complex. Request human input on focus area
      before proceeding with BMAD Party.
    action: wait_for_input
    inputs:
      prompt: |
        Repository analysis complete. Complexity score: {{ context.complexity_score }}/10
        
        Detected {{ context.improvement_potential.length }} improvement opportunities:
        {{ context.improvement_potential | format_list }}
        
        Which area should we focus on? Or enter custom goal:
      timeout: 300  # 5 minutes for human response
      options:
        - "Improve all areas (full enhancement)"
        - "Focus on performance optimization"
        - "Focus on code quality & maintainability"
        - "Focus on security & best practices"
        - "Custom goal (specify below)"
    outputs:
      human_goal: string
      focus_areas: array
    next_task: prepare_bmad_party

  # --------------------------------------------------------------------
  - id: generate_improvement_ideas
    name: Generate Improvement Ideas
    description: |
      No obvious improvements detected. Use LLM to brainstorm
      creative enhancement possibilities.
    action: llm_conversation
    inputs:
      model: claude-3-opus
      system: "You are a creative software architect. Generate innovative improvement ideas."
      prompt: |
        Repository context:
        {{ context | json_pretty }}
        
        This repository appears stable. Generate 5 creative enhancement ideas that could:
        1. Add novel features
        2. Improve developer experience
        3. Enable new use cases
        4. Optimize for future trends
        5. Create market differentiation
        
        Be bold and innovative. Think 10x improvements, not 10%.
      max_tokens: 2000
    timeout: 120
    outputs:
      improvement_ideas: array
    output_mapping:
      ideas:
        from: outputs.improvement_ideas
        to: context.improvement_potential
        transform: json_parse
    next_task: prepare_bmad_party

  # --------------------------------------------------------------------
  # PHASE 2: BMAD PARTY TIME COMPRESSION
  # --------------------------------------------------------------------
  - id: prepare_bmad_party
    name: Prepare BMAD Party Multi-LLM Session
    description: |
      Initialize Party Mode with multiple LLM participants.
      Each LLM brings unique perspective and capabilities.
    action: agent_orchestration
    inputs:
      mode: party
      participants: "{{ parameters.llm_participants }}"
      conversation_seed:
        topic: "Repository Enhancement: {{ context.project_type }}"
        goal: "{{ human_goal | default: 'Comprehensive improvement across all dimensions' }}"
        context: "{{ context | json }}"
        constraints:
          - "Maintain backward compatibility"
          - "Preserve existing functionality"
          - "Follow established patterns"
          - "Generate production-ready code"
      roles:
        claude-3-opus:
          role: "Strategic Architect"
          expertise: "System design, patterns, long-term vision"
        gpt-4-turbo:
          role: "Implementation Specialist"
          expertise: "Code generation, best practices, pragmatic solutions"
        gemini-1.5-pro:
          role: "Innovation Catalyst"
          expertise: "Creative solutions, novel approaches, edge cases"
      conversation_rules:
        - "Build on each other's ideas"
        - "Challenge assumptions constructively"
        - "Synthesize diverse perspectives"
        - "Converge on actionable solutions"
      time_compression_mode: true
      target_rounds: 50  # 50 rounds of 3-way conversation = 150 exchanges
      auto_synthesize: true
    timeout: 600  # 10 minutes human time = ~200 years AI time
    retry_policy:
      max_retries: 1
      backoff_strategy: none
      retry_on:
        - rate_limit
    outputs:
      conversation_history: array
      synthesized_insights: object
      patterns_discovered: array
      implementation_plan: object
      time_metrics:
        human_time: number
        ai_equivalent_time: number
        compression_ratio: number
    on_success:
      action: update_notion
      params:
        database_id: "{{ parameters.notion_database_id }}"
        page_type: experiment
        data:
          name: "{{ workflow.name }} - Run {{ workflow.run_id }}"
          status: "Complete"
          compression_ratio: "{{ outputs.time_metrics.compression_ratio }}"
          human_time: "{{ outputs.time_metrics.human_time }}"
          ai_time: "{{ outputs.time_metrics.ai_equivalent_time }}"
          patterns_found: "{{ outputs.patterns_discovered.length }}"
    on_failure:
      action: fallback_task
      fallback_task: single_llm_fallback
      params:
        reason: "Party mode failed, falling back to single LLM"
    next_task: analyze_party_outputs

  # --------------------------------------------------------------------
  - id: single_llm_fallback
    name: Single LLM Fallback (Party Mode Failed)
    description: |
      Party mode failed. Use single best LLM to generate insights.
    action: llm_conversation
    inputs:
      model: claude-3-opus
      system: "You are an expert software architect analyzing a repository."
      prompt: |
        Party mode failed. Perform solo analysis of:
        {{ context | json_pretty }}
        
        Generate:
        1. Key improvement opportunities
        2. Implementation priorities
        3. Architectural patterns to apply
        4. Step-by-step enhancement plan
      max_tokens: 4000
    timeout: 180
    outputs:
      insights: object
      implementation_plan: object
    next_task: analyze_party_outputs

  # --------------------------------------------------------------------
  - id: analyze_party_outputs
    name: Analyze BMAD Party Outputs
    description: |
      Extract patterns, anti-patterns, and actionable insights
      from the multi-LLM conversation.
    action: pattern_discovery
    inputs:
      conversation_history: "{{ bmad_party.outputs.conversation_history }}"
      synthesized_insights: "{{ bmad_party.outputs.synthesized_insights }}"
      analysis_dimensions:
        - architectural_patterns
        - code_quality_patterns
        - performance_patterns
        - security_patterns
        - anti_patterns
        - innovation_opportunities
      confidence_threshold: 0.7
      create_bmad_agents: true  # Auto-create agents from high-confidence patterns
    timeout: 120
    outputs:
      patterns: array
      anti_patterns: array
      new_agents: array
      recommendations: array
    output_mapping:
      patterns:
        from: outputs.patterns
        to: workflow_state.discovered_patterns
        transform: none
      agents:
        from: outputs.new_agents
        to: workflow_state.generated_agents
        transform: none
    on_success:
      action: notify
      params:
        title: "Pattern Discovery Complete"
        message: "Found {{ outputs.patterns.length }} patterns, {{ outputs.anti_patterns.length }} anti-patterns"
        channels:
          - console
          - notion
    next_task:
      default: generate_implementation_tasks
      conditions:
        - condition: "outputs.new_agents.length > 0"
          task_id: register_new_agents

  # --------------------------------------------------------------------
  - id: register_new_agents
    name: Register New BMAD Agents
    description: |
      Register newly discovered agents into BMAD system.
      These agents can be used in future workflows.
    action: agent_orchestration
    inputs:
      operation: register
      agents: "{{ analyze_party_outputs.outputs.new_agents }}"
      destination: ".bmad/agents/generated"
      format: yaml
      include_metadata:
        - discovery_date
        - source_experiment
        - confidence_score
        - capabilities
    timeout: 60
    outputs:
      registered_agents: array
      registry_path: string
    on_success:
      action: log
      params:
        message: "Registered {{ outputs.registered_agents.length }} new agents"
        level: info
    next_task: generate_implementation_tasks

  # --------------------------------------------------------------------
  # PHASE 3: IMPLEMENTATION GENERATION
  # --------------------------------------------------------------------
  - id: generate_implementation_tasks
    name: Generate Implementation Task Breakdown
    description: |
      Convert insights and patterns into concrete implementation tasks.
      Create story-like tasks with acceptance criteria.
    action: data_transformation
    inputs:
      source: "{{ bmad_party.outputs.implementation_plan }}"
      transform_to: tasks
      task_template:
        id: "TASK-{{ index }}"
        title: string
        description: string
        acceptance_criteria: array
        estimated_complexity: number  # 1-10
        dependencies: array
        tags: array
      prioritization_strategy: value_vs_effort
      max_tasks: 20  # Don't overwhelm, focus on high-value
    timeout: 60
    outputs:
      tasks: array
      execution_order: array
      estimated_total_time: string
    next_task:
      default: execute_tasks_parallel
      conditions:
        - condition: "outputs.tasks.length > 10"
          task_id: request_task_confirmation

  # --------------------------------------------------------------------
  - id: request_task_confirmation
    name: Request Task Execution Confirmation
    description: |
      Many tasks generated. Confirm execution plan with human.
    action: wait_for_input
    inputs:
      prompt: |
        Generated {{ task_count }} implementation tasks.
        Estimated time: {{ estimated_total_time }}
        
        Execution strategy:
        - High priority: {{ high_priority_count }} tasks
        - Medium priority: {{ medium_priority_count }} tasks
        - Low priority: {{ low_priority_count }} tasks
        
        Proceed with execution?
        - "Execute all tasks"
        - "Execute high priority only"
        - "Execute high + medium priority"
        - "Let me review tasks first"
        - "Cancel"
      timeout: 300
      options:
        - all
        - high
        - high_medium
        - review
        - cancel
    outputs:
      execution_scope: string
    next_task:
      default: execute_tasks_parallel
      conditions:
        - condition: "outputs.execution_scope === 'cancel'"
          task_id: workflow_complete
        - condition: "outputs.execution_scope === 'review'"
          task_id: display_task_review

  # --------------------------------------------------------------------
  - id: display_task_review
    name: Display Task Review Interface
    description: |
      Show detailed task breakdown for human review and selection.
    action: notification
    inputs:
      type: interactive
      title: "Task Review"
      content: "{{ generated_tasks | format_table }}"
      actions:
        - label: "Select tasks to execute"
          type: checkbox_list
          options: "{{ generated_tasks | map: 'id' }}"
    outputs:
      selected_tasks: array
    next_task: execute_tasks_parallel

  # --------------------------------------------------------------------
  - id: execute_tasks_parallel
    name: Execute Implementation Tasks (Parallel)
    description: |
      Execute selected tasks in parallel where possible.
      Respects dependencies and executes in optimal order.
    action: parallel_execution
    inputs:
      tasks: "{{ selected_tasks | default: generated_tasks }}"
      max_concurrent: 5
      respect_dependencies: true
      execution_strategy: dependency_aware
      task_executor:
        action: code_generation
        timeout_per_task: 180
        retry_policy:
          max_retries: 2
          backoff_strategy: exponential
    parallel: true
    timeout: 1800  # 30 minutes for all tasks
    outputs:
      completed_tasks: array
      failed_tasks: array
      execution_time: number
      files_modified: array
      files_created: array
    on_success:
      action: save_state
      params:
        key: implementation_results
        value: "{{ outputs }}"
    on_failure:
      action: continue
      params:
        message: "Some tasks failed but continuing with successful ones"
    next_task: validate_implementation

  # --------------------------------------------------------------------
  # PHASE 4: VALIDATION & FINALIZATION
  # --------------------------------------------------------------------
  - id: validate_implementation
    name: Validate Implementation Quality
    description: |
      Run tests, linters, type checking, and other validation.
      Ensure implementation meets quality standards.
    action: test_execution
    inputs:
      validations:
        - type: unit_tests
          command: "npm test"
          required: false
        - type: lint
          command: "npm run lint"
          required: true
        - type: type_check
          command: "npm run type-check"
          required: true
        - type: build
          command: "npm run build"
          required: true
      continue_on_failure: true
      report_format: detailed
    timeout: 600
    retry_policy:
      max_retries: 0  # Don't retry validation, fix and re-run
    outputs:
      validation_results: object
      passed: boolean
      errors: array
      warnings: array
    next_task:
      default: generate_summary
      conditions:
        - condition: "outputs.passed === false && outputs.errors.length > 0"
          task_id: attempt_auto_fix

  # --------------------------------------------------------------------
  - id: attempt_auto_fix
    name: Attempt Auto-Fix of Validation Errors
    description: |
      Try to automatically fix linting and type errors.
    action: code_generation
    inputs:
      operation: fix_errors
      errors: "{{ validate_implementation.outputs.errors }}"
      context: "{{ workflow_state }}"
      fix_strategy: conservative
      max_fixes: 10
    timeout: 300
    outputs:
      fixes_applied: array
      remaining_errors: array
    next_task:
      default: revalidate_after_fixes
      conditions:
        - condition: "outputs.remaining_errors.length === 0"
          task_id: generate_summary

  # --------------------------------------------------------------------
  - id: revalidate_after_fixes
    name: Re-validate After Auto-Fixes
    description: |
      Run validation again after applying auto-fixes.
    action: test_execution
    inputs:
      validations:
        - type: lint
          command: "npm run lint"
        - type: type_check
          command: "npm run type-check"
        - type: build
          command: "npm run build"
    timeout: 300
    outputs:
      validation_results: object
      passed: boolean
    next_task: generate_summary

  # --------------------------------------------------------------------
  - id: generate_summary
    name: Generate Experiment Summary
    description: |
      Create comprehensive summary of experiment results.
      Include time metrics, patterns discovered, implementation details.
    action: data_transformation
    inputs:
      sources:
        - "{{ workflow_state }}"
        - "{{ bmad_party.outputs }}"
        - "{{ analyze_party_outputs.outputs }}"
        - "{{ execute_tasks_parallel.outputs }}"
        - "{{ validate_implementation.outputs }}"
      template: markdown
      sections:
        - experiment_metadata
        - time_compression_metrics
        - patterns_discovered
        - agents_generated
        - implementation_summary
        - validation_results
        - recommendations
        - next_steps
      output_file: "{{ parameters.output_directory }}/EXPERIMENT_SUMMARY.md"
    timeout: 60
    outputs:
      summary_path: string
      summary_content: string
    next_task: update_notion_final

  # --------------------------------------------------------------------
  - id: update_notion_final
    name: Update Notion with Final Results
    description: |
      Push all experiment data to Notion database for tracking.
    action: api_call
    inputs:
      service: notion
      endpoint: "/v1/pages"
      method: POST
      headers:
        Authorization: "Bearer {{ env.NOTION_API_KEY }}"
        Notion-Version: "2022-06-28"
      body:
        parent:
          database_id: "{{ parameters.notion_database_id }}"
        properties:
          Name:
            title:
              - text:
                  content: "{{ workflow.name }} - {{ workflow.run_id }}"
          Status:
            select:
              name: "Complete"
          Type:
            select:
              name: "Time Compression"
          "Compression Ratio":
            number: "{{ bmad_party.outputs.time_metrics.compression_ratio }}"
          "Human Time":
            rich_text:
              - text:
                  content: "{{ bmad_party.outputs.time_metrics.human_time }} seconds"
          "AI Time":
            rich_text:
              - text:
                  content: "{{ bmad_party.outputs.time_metrics.ai_equivalent_time }}"
          "Patterns Found":
            number: "{{ analyze_party_outputs.outputs.patterns.length }}"
          "Agents Created":
            number: "{{ register_new_agents.outputs.registered_agents.length | default: 0 }}"
          "Tasks Completed":
            number: "{{ execute_tasks_parallel.outputs.completed_tasks.length }}"
          "Validation Passed":
            checkbox: "{{ validate_implementation.outputs.passed }}"
        children:
          - object: "block"
            type: "heading_2"
            heading_2:
              rich_text:
                - text:
                    content: "Experiment Summary"
          - object: "block"
            type: "paragraph"
            paragraph:
              rich_text:
                - text:
                    content: "{{ generate_summary.outputs.summary_content | truncate: 2000 }}"
    timeout: 60
    retry_policy:
      max_retries: 3
      backoff_strategy: exponential
      retry_on:
        - rate_limit
        - network_error
    on_failure:
      action: log
      params:
        message: "Failed to update Notion, but experiment succeeded"
        level: warning
    next_task: workflow_complete

  # --------------------------------------------------------------------
  - id: workflow_complete
    name: Workflow Complete
    description: |
      Final task. Display success message and cleanup.
    action: notification
    inputs:
      type: success
      title: "‚ö°üåå BMAD v2.0 Experiment Complete üåå‚ö°"
      message: |
        Experiment: {{ workflow.name }}
        Run ID: {{ workflow.run_id }}
        
        Time Compression:
        - Human time: {{ bmad_party.outputs.time_metrics.human_time }}s
        - AI equivalent: {{ bmad_party.outputs.time_metrics.ai_equivalent_time }}
        - Compression ratio: {{ bmad_party.outputs.time_metrics.compression_ratio }}x
        
        Results:
        - Patterns discovered: {{ analyze_party_outputs.outputs.patterns.length }}
        - New agents created: {{ register_new_agents.outputs.registered_agents.length | default: 0 }}
        - Tasks completed: {{ execute_tasks_parallel.outputs.completed_tasks.length }}
        - Validation: {{ validate_implementation.outputs.passed | yesno: "‚úÖ PASSED,‚ùå FAILED" }}
        
        Summary: {{ generate_summary.outputs.summary_path }}
        
        "Si ya deux portes, je cr√©e une 3e porte" ‚ú®
      channels:
        - console
        - desktop
    outputs:
      status: "complete"
      final_message: string

# ====================================================================
# GLOBAL ERROR HANDLERS
# ====================================================================
error_handlers:
  rate_limit:
    error_type: rate_limit
    action: retry
    params:
      wait_time: exponential
      max_wait: 300
  
  network_error:
    error_type: network_error
    action: retry
    params:
      max_retries: 3
  
  timeout:
    error_type: timeout
    action: notify
    params:
      message: "Task timeout exceeded"
      continue: true

# ====================================================================
# LIFECYCLE HOOKS
# ====================================================================
hooks:
  on_start:
    - action: log
      params:
        message: "üåå BMAD v2.0 Time Compression Workflow Started"
        level: info
    
    - action: save_state
      params:
        key: workflow_start
        value:
          timestamp: "{{ timestamp }}"
          run_id: "{{ workflow.run_id }}"
          parameters: "{{ parameters }}"
  
  on_complete:
    - action: log
      params:
        message: "‚úÖ Workflow completed successfully"
        level: info
    
    - action: trigger_webhook
      params:
        url: "{{ env.COMPLETION_WEBHOOK_URL }}"
        method: POST
        body:
          workflow: "{{ workflow.name }}"
          run_id: "{{ workflow.run_id }}"
          status: "success"
          metrics: "{{ bmad_party.outputs.time_metrics }}"
  
  on_abort:
    - action: log
      params:
        message: "‚ùå Workflow aborted"
        level: error
    
    - action: notification
      params:
        type: error
        title: "Workflow Aborted"
        message: "{{ abort_reason }}"
